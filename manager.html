<!DOCTYPE html>
<html lang="en-GB">
    <head>
        <meta charset="utf-8"> 
        <meta name="description" 
              content="Home page for Milburn Parish Counci : About, Minutes, Agendas, Policies, Financial Statements, Sundry">
        <title>Home - Milburn Parish Council</title>
        <meta name="keywords" 
              content="About, minutes, agendas, policies, financial statements, sundry">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">     

        <!-- Bootstrap includes from https://www.w3schools.com/bootstrap4/tryit.asp?filename=trybs_carousel2 -->

        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

        <!-- sortableJS styles -->
        <link rel="stylesheet" type="text/css" href="st/theme.css">
        <!-- code for datepicker -->
        <script src="//code.jquery.com/ui/1.12.1/jquery-ui.js"></script>


        <style>
            div.ui-datepicker {
                font-size:12px;
                background: gainsboro;
                border: 1px solid #555;
                color: blue;
            }

            /* current input value background color */
            .ui-datepicker-current-day
            {
                background: #83C948
            }
            /* today's background color */
            .ui-datepicker-today 
            {
                background: #83C948
            }

            #ui-datepicker-div {z-index:9999 !important}

            .launchpadlink {
                width: 5.5em;
                padding: .5em;
                color: blue;
                border: 1px solid black;
                border-radius: .5em;
                padding: .5em;
                display: inline-block;
                text-decoration: none !important;
                margin: 1em auto 1em auto;
            }        

            .view {
                background-color: LAVENDER;
            }

            .amend {
                background-color: MEDIUMAQUAMARINE;
            }

            .configure {
                background-color: WHEAT;
            }

            label {
                font-weight: bold;
            }
        </style>

    </head>
    <body>

        <form id = 'dummyform'> <!-- dummy form used to communicate with php helper functions -->
        </form>

        <!--  ++++++++++++  Header ++++++++++++++++++++++++++ -->

        <div style = 'margin: 2vh auto 2vh auto; width: 75%; text-align: center;'>
            <div style ='padding: 2vh; background: white;'>
                <h2 style = "width: 70%; margin: 1vh auto auto auto; padding-top: 1vh; padding-bottom: 1vh; background: Aquamarine;">Parish Council Website Management Screen</h2>

                <!--  ++++++++++++  Controls ++++++++++++++++++++++++++ -->

                <table style="width: 70%; margin: 2vh auto 2vh auto; border: 1px solid black; padding: 1.5vh; border-collapse: separate; background: white;">
                    <tr>
                        <td><p id = "entriesbutton" class="launchpadlink" style = "width: 12em;" title="Add/remove/edit Entries for Sections">
                                <a onclick = "displayCurrentSectionUpdateView('anchor');">Manage Entries<br>
                                </a>
                                <span id ="entriesbuttonpicklist"></span>
                            </p>
                        </td>
                        <td>
                            <a id = "carouselbutton" class="launchpadlink" title="Add/remove/reorder/edit Slides within the Carousel"
                               onclick = "updateTarget = 'carousel'; displayCarouselUpdateView();">Configure<br>Carousel</a>
                        </td>
                        <td>
                            <a id = "sectionsbutton" class="launchpadlink" title="Add/remove/reorder/edit Sections"
                               onclick = "updateTarget = 'sections'; displaySectionsUpdateView();">Configure<br>Sections</a>
                        </td>
                        <td>
                            <a id = "viewbutton" class="launchpadlink" title="Launch the website in a popup"
                               onclick ="popUpWindow = window.open('index.html', 'PC website popup',
                                               width = ' + (parseInt(window.innerWidth) * 0.9) + ', height = ' + (parseInt(window.innerHeight) * 0.9) + ', left = ' + (parseInt(window.innerWidth) * 0.05) + ', top = ' + (parseInt(window.innerHeight) * 0.1) + ', resizable = 'yes');">
                                Launch<br>Website</a>
                        </td>
                    </tr>
                </table>
            </div>
        </div>

        <!--  ++++++++++++  Code for Active Control   ++++++++++++++++++++++++++ -->

        <div id = 'currentcontrol'>
        </div>

        <!--  ++++++++++++  Support popups   ++++++++++++++++++++++++++ -->

        <div id = "savetypechangewarning" style ="
             display: none; width: 45vw;
             position: absolute; margin-left: auto; margin-right: auto; left: 0; right: 0; top: 50vh; 
             padding: 3vh 2vw 2vh 2vw; border: 1px solid black; 
             text-align: center;
             background: white;
             z-index: 10;">
            <p>Changing the type of this Section will have an effect on the titles
                of any Entries in the section. Changing the type for a standard_title
                section will cause titles for entries for the section
                to be replaced by dummy dates. Changing
                the type for a date_title section will cause the date elements of the titles
                for its entries to be replaced by a counter.
            </p>
            <button type="button" class="ml-2 mr-2 btn-sm btn-primary" 
                    title="Click to confirm and close the popup" 
                    onmousedown="savetypechangewarning.style.display = 'none';">Ok
            </button>
        </div>

        <script>

            function applyDatepicker(elementId) {

                var oldDate = document.getElementById(elementId).placeholder;
                $('#' + elementId).datepicker();
                $('#' + elementId).datepicker('option', 'dateFormat', 'yy-mm-dd');
                $('#' + elementId).datepicker('option', 'changeMonth', true);
                $('#' + elementId).datepicker('option', 'changeYear', true);
                $('#' + elementId).datepicker('option', 'yearRange', '1999:c');
                $('#' + elementId).datepicker()
                        .on('input change', function (e) {
                            var newDate = document.getElementById(elementId).value;
                        });
            }

            function launchUpdateView() {

                // Build the picklist and then display the current Section Update View

                var form = document.forms.namedItem("dummyform");
                var oData = new FormData(form);
                oData.append("helper_type", "build_section_picklist");
                // if there's a value for lastsectionid in local storage, set this

                currentSectionId = '';
                if (localStorage.getItem('pcouncillastsectionid')) {
                    currentSectionId = localStorage.getItem('pcouncillastsectionid');
                }
                oData.append("current_section_id", currentSectionId);
                var oReq = new XMLHttpRequest();
                oReq.open("POST", "php/manager_helpers.php", true);
                oReq.onload = function (oEvent) {
                    if (oReq.status == 200) {

                        var response = oReq.responseText;
                        if (response.indexOf("%timed_out%") != -1) {
                            handleTimeout();
                            return;
                        }
                        if (response.indexOf("%failed%") != -1) {
                            alert(response);
                        } else {
                            document.getElementById('entriesbuttonpicklist').innerHTML = response;
                            // display updateview for the last section used
                            updateTarget = 'entries';
                            displayCurrentSectionUpdateView('anchor');
                        }
                    }
                };
                oReq.send(oData);
            }

            var currentSectionId;
            var currentSectionType;
            function displayCurrentSectionUpdateView(entryPoint) {

                // entryPoint tells you if yu've entered for the Anchor button ("anchor")
                // or from the options select element ("select")

                if (entryPoint == "anchor") {

                    // we've not been explicitly given a section target so need to decide
                    // what to do. First see if there's a value in local storage

                    if (localStorage.getItem('pcouncillastsectionid')) {
                        currentSectionId = localStorage.getItem('pcouncillastsectionid');
                    } else {
                        var sectionspicklist = document.getElementById('sectionspicklist')
                        currentSectionId = sectionspicklist.options[sectionspicklist.selectedIndex].value;
                    }
                } else {
                    var sectionspicklist = document.getElementById('sectionspicklist')
                    currentSectionId = sectionspicklist.options[sectionspicklist.selectedIndex].value;
                }

                var form = document.forms.namedItem("dummyform");
                var oData = new FormData(form);
                oData.append("helper_type", "build_entries_update_table");
                oData.append("section_id", currentSectionId);
                var oReq = new XMLHttpRequest();
                oReq.open("POST", "php/manager_helpers.php", true);
                oReq.onload = function (oEvent) {
                    if (oReq.status == 200) {

                        var response = oReq.responseText;
                        if (response.indexOf("%timed_out%") != -1) {
                            handleTimeout();
                            return;
                        }
                        var response = oReq.responseText;
                        if (response.indexOf("%failed%") != -1) {
                            alert(response);
                        } else {
                            document.getElementById('currentcontrol').innerHTML = response;
                            localStorage.setItem('pcouncillastsectionid', currentSectionId);
                            // the sectionType for currentSectionId is tucked away in a hidden span in the html you've
                            // just placed in currentcontrol

                            currentSectionType = document.getElementById('currentsectiontype').innerHTML
                        }
                    }
                };
                oReq.send(oData);
            }

            function insertEntry() {

                if (currentSectionType == "date_title") {
                    var entryDate = document.getElementById("entrydate").value;
                    var entrySuffix = document.getElementById("entrysuffix").value;
                } else {
                    var entryTitle = document.getElementById("entrytitle").value;
                }

                var entryFilename = document.getElementById("entryfilename").value;

                if (!validEntry(currentSectionType, entryDate, entrySuffix, entryTitle, entryFilename))
                    return;

                var form = document.forms.namedItem('entryform');
                var oData = new FormData(form);
                oData.append("helper_type", "insert_entry");
                oData.append("section_id", currentSectionId);
                oData.append("section_type", currentSectionType);
                if (currentSectionType == "date_title") {
                    oData.append("entry_date", document.getElementById("entrydate").value);
                    oData.append("entry_suffix", document.getElementById("entrysuffix").value);
                } else {
                    oData.append("entry_title", document.getElementById("entrytitle").value);
                }

                var oReq = new XMLHttpRequest();
                oReq.open("POST", "php/manager_helpers.php", true);
                oReq.onload = function (oEvent) {
                    if (oReq.status == 200) {

                        var response = oReq.responseText;
                        if (response.indexOf("%timed_out%") != -1) {
                            handleTimeout();
                            return;
                        }
                        var response = oReq.responseText;
                        if (response.indexOf("%failed%") != -1) {
                            alert(response);
                        } else {
                            if (response.indexOf("Oops") != -1) {
                                displayFailureMessage(response);
                            } else {
                                displayCurrentSectionUpdateView('anchor');
                            }
                        }
                    }
                };
                oReq.send(oData);
            }

            function updateEntry(entryIndex) {

                var entryDate = '';
                var entrySuffix = '';
                var entryTitle = '';
                var currentEntryFilename = document.getElementById('currententryfilename' + entryIndex).innerHTML;
                var entryFilename = currentSectionId;

                if (currentSectionType == "date_title") {
                    entryDate = document.getElementById("entrydate" + entryIndex).value;
                    entrySuffix = document.getElementById("entrysuffix" + entryIndex).value;
                    entryFilename += "_" + entryDate;
                    if (entrySuffix != '') {
                        entryFilename += "_" + entrySuffix;
                    }
                } else {
                    entryTitle = document.getElementById("entrytitle" + entryIndex).value;
                    entryFilename += "_" + entryTitle;
                }
                entryFilename += ".pdf";

                if (!validEntry(currentSectionType, entryDate, entrySuffix, entryTitle, entryFilename))
                    return;

                var form = document.forms.namedItem("entryform" + entryIndex);
                var oData = new FormData(form);
                oData.append("helper_type", "update_entry");
                oData.append("entry_index", entryIndex);
                oData.append("section_id", currentSectionId);
                oData.append("section_type", currentSectionType);
                oData.append("current_filename", currentEntryFilename);
                if (currentSectionType == "date_title") {
                    oData.append("entry_date", document.getElementById("entrydate" + entryIndex).value);
                    oData.append("entry_suffix", document.getElementById("entrysuffix" + entryIndex).value);
                } else {
                    oData.append("entry_title", document.getElementById("entrytitle" + entryIndex).value);
                }
                var sourceStatus = "source file not provided";
                if (document.getElementById("entryfilename" + entryIndex).value != '')
                    sourceStatus = "new source file provided";
                oData.append("source_status", sourceStatus);

                var oReq = new XMLHttpRequest();
                oReq.open("POST", "php/manager_helpers.php", true);
                oReq.onload = function (oEvent) {
                    if (oReq.status == 200) {

                        var response = oReq.responseText;
                        if (response.indexOf("%timed_out%") != -1) {
                            handleTimeout();
                            return;
                        }
                        var response = oReq.responseText;
                        if (response.indexOf("%failed%") != -1) {
                            alert(response);
                        } else {
                            if (response.indexOf("Oops") != -1) {
                                displayFailureMessage(response);
                            } else {
                                displayCurrentSectionUpdateView('anchor');
                            }
                        }
                    }
                };
                oReq.send(oData);
            }

            function validEntry(sectionType, entryDate, entrySuffix, entryTitle, entryFilename) {

                if (sectionType == "date_title") {

                    if (entryDate == '') {
                        displayFailureMessage("Oops - you need to specify an entry date");
                        return false;
                    }

                    var illegalCharacter = checkForImpermissibleCharacter(entrySuffix);
                    if (illegalCharacter != '') {
                        displayFailureMessage("Oops - character " + illegalCharacter + " is not allowed in Suffix");
                        return false;
                    }

                } else {

                    if (entryTitle == '') {
                        displayFailureMessage("Oops - you need to specify an entry title");
                        return false;
                    }

                    illegalCharacter = checkForImpermissibleCharacter(entryTitle);
                    if (illegalCharacter != '') {
                        displayFailureMessage("Oops - character " + illegalCharacter + " is not allowed in Title");
                        return false;
                    }
                }

                if (entryFilename == '') {
                    displayFailureMessage("Oops - you need to specify a filename");
                    return false;
                }
                return true;

            }

            function checkForImpermissibleCharacter(characterString) {

                // check that characterString doesnt contain an _ character or anything that would
                // be impermissible in a windows or unix filename

                var illegalChar = '';
                if (characterString.includes('_'))
                    illegalChar = '_';
                if (characterString.includes('£'))
                    illegalChar = '£';
                if (characterString.includes('%'))
                    illegalChar = '%';
                if (characterString.includes('&'))
                    illegalChar = '&';
                if (characterString.includes('{'))
                    illegalChar = '{';
                if (characterString.includes('}'))
                    illegalChar = '}';
                if (characterString.includes('<'))
                    illegalChar = '<';
                if (characterString.includes('>'))
                    illegalChar = '>';
                if (characterString.includes('*'))
                    illegalChar = '*';
                if (characterString.includes('"'))
                    illegalChar = '"';
                if (characterString.includes("'"))
                    illegalChar = "'";
                if (characterString.includes('+'))
                    illegalChar = '+';
                if (characterString.includes('|'))
                    illegalChar = '!';
                if (characterString.includes('='))
                    illegalChar = '=';
                return illegalChar;

            }

            function deleteEntry(filename) {

                var form = document.forms.namedItem("dummyform");
                var oData = new FormData(form);
                oData.append("helper_type", "delete_entry");
                oData.append("filename", filename);
                var oReq = new XMLHttpRequest();
                oReq.open("POST", "php/manager_helpers.php", true);
                oReq.onload = function (oEvent) {
                    if (oReq.status == 200) {

                        var response = oReq.responseText;
                        if (response.indexOf("%timed_out%") != -1) {
                            handleTimeout();
                            return;
                        }
                        var response = oReq.responseText;
                        if (response.indexOf("%failed%") != -1) {
                            alert(response);
                        } else {
                            displayCurrentSectionUpdateView('anchor');
                        }
                    }
                };
                oReq.send(oData);
            }

            function displayCarouselUpdateView() {

                var form = document.forms.namedItem("dummyform");
                var oData = new FormData(form);
                oData.append("helper_type", "build_carousel_update_table");
                var oReq = new XMLHttpRequest();
                oReq.open("POST", "php/manager_helpers.php", true);
                oReq.onload = function (oEvent) {
                    if (oReq.status == 200) {

                        var response = oReq.responseText;
                        if (response.indexOf("%timed_out%") != -1) {
                            handleTimeout();
                            return;
                        }
                        var response = oReq.responseText;
                        if (response.indexOf("%failed%") != -1) {
                            alert(response);
                        } else {
                            document.getElementById('currentcontrol').innerHTML = response;
                            new Sortable(slidessortablelist, {
                                animation: 150,
                                ghostClass: 'sortable-ghost'
                            });
                        }
                    }
                };
                oReq.send(oData);
            }

            function updateWebsiteTitle() {

                var form = document.forms.namedItem("dummyform");
                var oData = new FormData(form);
                oData.append("helper_type", "update_website_title");
                oData.append("website_title", document.getElementById('websitetitle').value);

                var oReq = new XMLHttpRequest();
                oReq.open("POST", "php/manager_helpers.php", true);
                oReq.onload = function (oEvent) {
                    if (oReq.status == 200) {

                        var response = oReq.responseText;
                        if (response.indexOf("%timed_out%") != -1) {
                            handleTimeout();
                            return;
                        }
                        var response = oReq.responseText;
                        if (response.indexOf("%failed%") != -1) {
                            alert(response);
                        } else {
                            displayCarouselUpdateView('anchor');
                        }
                    }
                };
                oReq.send(oData);
            }

            function insertSlide() {

                // Note that to get the $_FILES Post data across to helpers we have to use a
                // real form (ie one deeclared as type POST etc)

                var slideTitle = document.getElementById("slidetitle").value

                var illegalCharacter = checkForImpermissibleCharacter(slideTitle);
                if (illegalCharacter != '') {
                    displayFailureMessage("Oops - character " + illegalCharacter + " is not allowed in slide title");
                    return false;
                }

                if (slideTitle == '') {
                    displayFailureMessage("Oops - you need to specify a title");
                    return false;
                }

                var slideFilename = document.getElementById("slidefilename").value

                if (slideFilename == '') {
                    displayFailureMessage("Oops - you need to specify a filename");
                    return false;
                }

                var form = document.forms.namedItem('slideform');
                var oData = new FormData(form);
                oData.append("helper_type", "insert_slide");
                oData.append("slide_title", slideTitle);

                var oReq = new XMLHttpRequest();
                oReq.open("POST", "php/manager_helpers.php", true);
                oReq.onload = function (oEvent) {
                    if (oReq.status == 200) {

                        var response = oReq.responseText;
                        if (response.indexOf("%timed_out%") != -1) {
                            handleTimeout();
                            return;
                        }
                        var response = oReq.responseText;
                        if (response.indexOf("%failed%") != -1) {
                            alert(response);
                        } else {
                            if (response.indexOf("Oops") != -1) {
                                displayFailureMessage(response);
                            } else {
                                displayCarouselUpdateView('anchor');
                            }
                        }
                    }
                };
                oReq.send(oData);
            }

            function updateSlide(slideIndex) {

                var slideTitle = document.getElementById("slidetitle" + slideIndex).value

                var illegalCharacter = checkForImpermissibleCharacter(slideTitle);
                if (illegalCharacter != '') {
                    displayFailureMessage("Oops - character " + illegalCharacter + " is not allowed in slide title");
                    return false;
                }

                if (slideTitle == '') {
                    displayFailureMessage("Oops - slide title cannot be blank");
                    return false;
                }

                var form = document.forms.namedItem("slideform" + slideIndex);
                var oData = new FormData(form);
                oData.append("helper_type", "update_slide");
                oData.append("slide_index", slideIndex);
                oData.append("slide_title", slideTitle);

                var sourceStatus = "source file not provided";
                if (document.getElementById("slidefilename" + slideIndex).value != '')
                    sourceStatus = "new source file provided";
                oData.append("source_status", sourceStatus);

                var oReq = new XMLHttpRequest();
                oReq.open("POST", "php/manager_helpers.php", true);
                oReq.onload = function (oEvent) {
                    if (oReq.status == 200) {

                        var response = oReq.responseText;
                        if (response.indexOf("%timed_out%") != -1) {
                            handleTimeout();
                            return;
                        }
                        var response = oReq.responseText;
                        if (response.indexOf("%failed%") != -1) {
                            alert(response);
                        } else {
                            if (response.indexOf("Oops") != -1) {
                                displayFailureMessage(response);
                            } else {
                                displayCarouselUpdateView();
                            }
                        }
                    }
                };
                oReq.send(oData);
            }

            function deleteSlide(slideIndex) {

                var slideTitle = document.getElementById('slidetitle' + slideIndex).value;

                message = "Do you really want to delete the slide for '";
                message += slideTitle + "'";
                if (!confirm(message))
                    return;

                var form = document.forms.namedItem("slideform" + slideIndex);
                var oData = new FormData(form);
                oData.append("helper_type", "delete_slide");
                oData.append("slide_index", slideIndex);
                var oReq = new XMLHttpRequest();
                oReq.open("POST", "php/manager_helpers.php", true);
                oReq.onload = function (oEvent) {
                    if (oReq.status == 200) {

                        var response = oReq.responseText;
                        if (response.indexOf("%timed_out%") != -1) {
                            handleTimeout();
                            return;
                        }
                        var response = oReq.responseText;
                        if (response.indexOf("%failed%") != -1) {
                            alert(response);
                        } else {
                            if (response.indexOf("Oops") != -1) {
                                displayFailureMessage(response);
                            } else {
                                displayCarouselUpdateView();
                            }
                        }
                    }
                };
                oReq.send(oData);
            }

            function reorderSlides() {

                var slides = document.getElementsByClassName('slideentry');

                var slidesPrecursorJson = "[";
                for (var i = 0; i < slides.length; i++) {

                    var j = slides[i].innerHTML;

                    slidesPrecursorJson += '{';
                    slidesPrecursorJson += '"slide_title" : "' + document.getElementById('slidetitle' + j).value + '"},';
                }
                slidesPrecursorJson = slidesPrecursorJson.substring(0, slidesPrecursorJson.length - 1);
                slidesPrecursorJson += "]";

                var form = document.forms.namedItem("dummyform");
                var oData = new FormData(form);
                oData.append("helper_type", "reorder_slides");
                oData.append("slides_precursor_json", slidesPrecursorJson);
                var oReq = new XMLHttpRequest();
                oReq.open("POST", "php/manager_helpers.php", true);
                oReq.onload = function (oEvent) {
                    if (oReq.status == 200) {

                        var response = oReq.responseText;
                        if (response.indexOf("%timed_out%") != -1) {
                            handleTimeout();
                            return;
                        }
                        var response = oReq.responseText;
                        if (response.indexOf("%failed%") != -1) {
                            alert(response);
                        } else {
                            displayCarouselUpdateView();
                        }
                    }
                }
                ;
                oReq.send(oData);
            }

            function displaySectionsUpdateView() {

                var form = document.forms.namedItem("dummyform");
                var oData = new FormData(form);
                oData.append("helper_type", "build_sections_update_table");
                var oReq = new XMLHttpRequest();
                oReq.open("POST", "php/manager_helpers.php", true);
                oReq.onload = function (oEvent) {
                    if (oReq.status == 200) {

                        var response = oReq.responseText;
                        if (response.indexOf("%timed_out%") != -1) {
                            handleTimeout();
                            return;
                        }
                        var response = oReq.responseText;
                        if (response.indexOf("%failed%") != -1) {
                            alert(response);
                        } else {
                            document.getElementById('currentcontrol').innerHTML = response;
                            new Sortable(sectionssortablelist, {
                                animation: 150,
                                ghostClass: 'sortable-ghost'
                            });
                        }
                    }
                };
                oReq.send(oData);
            }

            function insertSection() {

                var sectionId = document.getElementById('sectionid').value
                var illegalCharacter = checkForImpermissibleCharacter(sectionId);
                if (illegalCharacter != '') {
                    displayFailureMessage("Oops - character " + illegalCharacter + " is not allowed in ssection id");
                    return false;
                }

                var sectionId = document.getElementById('sectionid').value;
                if (sectionId == '') {
                    displayFailureMessage("Oops - you need to supply an id tag for the section");
                    return false;
                }

                var sectionHeader = document.getElementById('sectionheader').value;
                if (sectionHeader == '') {
                    displayFailureMessage("Oops - you need to supply a header for the section");
                    return false;
                }

                var form = document.forms.namedItem("dummyform");
                var oData = new FormData(form);
                oData.append("helper_type", "insert_section");
                oData.append("section_id", sectionId);
                oData.append("section_header", document.getElementById('sectionheader').value);
                oData.append("section_prefix", document.getElementById('sectionprefix').value);
                if (document.getElementById('sectiontypedate').checked) {
                    oData.append("section_type", "date_title");
                } else {
                    oData.append("section_type", "standard_title");
                }

                var oReq = new XMLHttpRequest();
                oReq.open("POST", "php/manager_helpers.php", true);
                oReq.onload = function (oEvent) {
                    if (oReq.status == 200) {

                        var response = oReq.responseText;
                        if (response.indexOf("%timed_out%") != -1) {
                            handleTimeout();
                            return;
                        }
                        var response = oReq.responseText;
                        if (response.indexOf("%failed%") != -1) {
                            alert(response);
                        } else {
                            if (response.indexOf("Oops") != -1) {
                                displayFailureMessage(response);
                            } else {
                                displaySectionsUpdateView();
                            }
                        }
                    }
                };
                oReq.send(oData);
            }

            function updateSection(sectionIndex) {

                var form = document.forms.namedItem("dummyform");
                var oData = new FormData(form);
                oData.append("helper_type", "update_section");
                oData.append("section_index", sectionIndex);
                oData.append("section_id", document.getElementById('sectionid' + sectionIndex).innerHTML.trim());
                oData.append("section_header", document.getElementById('sectionheader' + sectionIndex).value);
                oData.append("section_prefix", document.getElementById('sectionprefix' + sectionIndex).value);
                if (document.getElementById('sectiontypedate' + sectionIndex).checked) {
                    oData.append("section_type", 'date_title');
                } else {
                    oData.append("section_type", 'standard_title');
                }

                var oReq = new XMLHttpRequest();
                oReq.open("POST", "php/manager_helpers.php", true);
                oReq.onload = function (oEvent) {
                    if (oReq.status == 200) {

                        var response = oReq.responseText;
                        if (response.indexOf("%timed_out%") != -1) {
                            handleTimeout();
                            return;
                        }
                        var response = oReq.responseText;
                        if (response.indexOf("%failed%") != -1) {
                            alert(response);
                        } else {
                            if (response.indexOf("Oops") != -1) {
                                displayFailureMessage(response);
                            } else {
                                displaySectionsUpdateView();
                            }
                        }
                    }
                };
                oReq.send(oData);
            }

            var savetypechangewarning = document.getElementById('savetypechangewarning');
            function sendSaveTypeChangeWarning() {

                // attempts to use 'confirm' to display the popup failed because it clocked
                // the operation of the radio button
                savetypechangewarning.style.display = "block";
            }

            function deleteSection(sectionIndex) {

                message = "Do you really want to delete the checked section(s)? Any associated ";
                message += "Entry files will also be deleted. ";
                if (!confirm(message))
                    return;

                var form = document.forms.namedItem("dummyform");
                var oData = new FormData(form);
                oData.append("helper_type", "delete_section");
                oData.append("section_index", sectionIndex);
                var oReq = new XMLHttpRequest();
                oReq.open("POST", "php/manager_helpers.php", true);
                oReq.onload = function (oEvent) {
                    if (oReq.status == 200) {

                        var response = oReq.responseText;
                        if (response.indexOf("%timed_out%") != -1) {
                            handleTimeout();
                            return;
                        }
                        var response = oReq.responseText;
                        if (response.indexOf("%failed%") != -1) {
                            alert(response);
                        } else {
                            if (response.indexOf("Oops") != -1) {
                                displayFailureMessage(response);
                            } else {
                                displaySectionsUpdateView();
                            }
                        }
                    }
                };
                oReq.send(oData);
            }

            function reorderSections(sectionIndex) {

                var sections = document.getElementsByClassName('sectionentry');

                var sectionsPrecursorJson = "[";
                for (var i = 0; i < sections.length; i++) {

                    var j = sections[i].innerHTML;

                    sectionsPrecursorJson += '{';
                    sectionsPrecursorJson += '"section_id" : "' + (document.getElementById('sectionid' + j).innerHTML).trim() + '",';
                    sectionsPrecursorJson += '"section_header" : "' + document.getElementById('sectionheader' + j).value + '",';
                    sectionsPrecursorJson += '"section_prefix" : "' + document.getElementById('sectionprefix' + j).value + '",';
                    if (document.getElementById('sectiontypedate' + j).checked) {
                        sectionsPrecursorJson += '"section_type" : "date_title"},';
                    } else {
                        sectionsPrecursorJson += '"section_type" : "standard_title"},';
                    }
                }
                sectionsPrecursorJson = sectionsPrecursorJson.substring(0, sectionsPrecursorJson.length - 1);
                sectionsPrecursorJson += "]";

                var form = document.forms.namedItem("dummyform");
                var oData = new FormData(form);
                oData.append("helper_type", "reorder_sections");
                oData.append("sections_precursor_json", sectionsPrecursorJson);
                var oReq = new XMLHttpRequest();
                oReq.open("POST", "php/manager_helpers.php", true);
                oReq.onload = function (oEvent) {
                    if (oReq.status == 200) {

                        var response = oReq.responseText;
                        if (response.indexOf("%timed_out%") != -1) {
                            handleTimeout();
                            return;
                        }
                        var response = oReq.responseText;
                        if (response.indexOf("%failed%") != -1) {
                            alert(response);
                        } else {
                            displaySectionsUpdateView();
                        }
                    }
                }
                ;
                oReq.send(oData);
            }

            var updateTarget;
            function clearMessageArea() {

                document.getElementById('messagearea').innerHTML = '';
            }

            function displaySuccessMessage(messageContent) {

                document.getElementById('messagearea').innerHTML = messageContent;
                document.getElementById('messagearea').style.color = 'blue';
            }

            function displayFailureMessage(messageContent) {

                document.getElementById('messagearea').innerHTML = messageContent;
                document.getElementById('messagearea').style.color = 'red';
            }

            function openFile(filename) {

                // Chrome won't let us connect to local resources so to provide a stopgap for testing
                // we link to server resources. All that's different between local and live running is
                // the form of the hreflink Add a "time" parameter to force reload

                dateObject = new Date();
                currentTime = dateObject.getTime();
                var hreflink = 'entries/' + filename + "?" + currentTime;


                // open links in new window unless this already exists, in which case overwrite

                window.open(hreflink, "milburnpc")
            }

            function handleTimeout() {

                // An attempt to execute a helper_function has returned a %timed-out% response. This
                // might be a genuine timeout of the php session record or could be a hacking attempt.
                // EIth way invite the user to login

                window.location.assign("login.html");
            }

            window.onload = function () {
                launchUpdateView();

            }

        </script>

        <!-- Latest Sortable -->
        <script src="sortable.js"></script>

    </body>
</html>



